{% extends 'layouts/main.html' %}
{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <h3 class="card-title mb-4">Create New Event</h3>
                <form method="POST">
                    <div class="row">
                        <!-- Left Column -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="title" class="form-label">Event Title</label>
                                <input type="text" class="form-control" id="title" name="title" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="description" class="form-label">Description</label>
                                <textarea class="form-control" id="description" name="description" rows="4" required></textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label for="event_type" class="form-label">Event Type</label>
                                <select class="form-select" id="event_type" name="event_type" required>
                                    <option value="">Select Event Type</option>
                                    <option value="Exam_schedule">Exam Schedule</option>
                                    <option value="Timetable">Timetable</option>
                                    <option value="GN-Announcement">General Announcement</option>
                                    <option value="Assignment">Assignment</option>
                                    <option value="Results">Results</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="visibility" class="form-label">Visibility</label>
                                <select class="form-select" id="visibility" name="visibility" required>
                                    <option value="Teachers" selected>Teachers only</option>
                                    <option value="all">Teachers and Students</option>
                                </select>
                            </div>

                            <!-- Hidden Fields -->
                            <div class="mb-3 exam-field" style="display: none;">
                                <label class="form-label">Years</label>
                                <div class="mb-2">
                                    <input type="checkbox" id="selectAllYears" class="form-check-input me-2">
                                    <label for="selectAllYears" class="form-check-label">Select All Years</label>
                                </div>
                                <select class="form-select" id="years" name="years[]" multiple>
                                    <option value="1">First Year</option>
                                    <option value="2">Second Year</option>
                                    <option value="3">Third Year</option>
                                    <option value="4">Fourth Year</option>
                                </select>
                                <small class="form-text text-muted">Hold Ctrl/Cmd to select multiple years</small>
                            </div>
                        </div>
                        
                        <!-- Right Column -->
                        <div class="col-md-6">
                            <div class="mb-3 exam-field" style="display: none;">
                                <label class="form-label">Departments</label>
                                <div class="mb-2">
                                    <input type="checkbox" id="selectAllDepts" class="form-check-input me-2">
                                    <label for="selectAllDepts" class="form-check-label">Select All Departments</label>
                                </div>
                                <select class="form-select" id="departments" name="departments[]" multiple>
                                    <option value="CS">Computer Science</option>
                                    <option value="IT">Information Technology</option>
                                    <option value="ECE">Electronics & Communication</option>
                                    <option value="EEE">Electrical & Electronics</option>
                                    <option value="MECH">Mechanical Engineering</option>
                                    <option value="CIVIL">Civil Engineering</option>
                                </select>
                            </div>
                            
                            <div class="mb-3 exam-field" style="display: none;">
                                <label class="form-label">Semesters</label>
                                <div class="mb-2">
                                    <input type="checkbox" id="selectAllSems" class="form-check-input me-2">
                                    <label for="selectAllSems" class="form-check-label">Select All Semesters</label>
                                </div>
                                <select class="form-select" id="semesters" name="semesters[]" multiple>
                                    <option value="1">Semester 1</option>
                                    <option value="2">Semester 2</option>
                                    <option value="3">Semester 3</option>
                                    <option value="4">Semester 4</option>
                                    <option value="5">Semester 5</option>
                                    <option value="6">Semester 6</option>
                                    <option value="7">Semester 7</option>
                                    <option value="8">Semester 8</option>
                                </select>
                            </div>
                            
                            <div class="mb-3 exam-field" style="display: none;">
                                <label class="form-label">Courses</label>
                                <div class="mb-2">
                                    <input type="checkbox" id="selectAllCourses" class="form-check-input me-2">
                                    <label for="selectAllCourses" class="form-check-label">Select All Courses</label>
                                </div>
                                <select class="form-select" id="courses" name="courses[]" multiple>
                                    <option value="PYTHON">Python Programming</option>
                                    <option value="JAVA">Java Programming</option>
                                    <option value="DBMS">Database Management Systems</option>
                                    <option value="DS">Data Structures</option>
                                    <option value="OS">Operating Systems</option>
                                    <option value="CN">Computer Networks</option>
                                    <option value="WEB">Web Technologies</option>
                                    <option value="AI">Artificial Intelligence</option>
                                </select>
                            </div>

                            <div class="mb-3 exam-field" style="display: none;">
                                <label for="question_bank_id" class="form-label">Question Bank</label>
                                <select class="form-select" id="question_bank_id" name="question_bank_id">
                                    <option value="">Select a Question Bank</option>
                                    {% for qb in question_banks %}
                                    <option value="{{ qb.id }}">{{ qb.name }} ({{ qb.difficulty }})</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="mb-3 exam-field" style="display: none;">
                                <label for="exam_duration" class="form-label">Exam Duration (minutes)</label>
                                <input type="number" class="form-control" id="exam_duration" name="exam_duration" min="1" placeholder="e.g., 60">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary">Create Event</button>
                            <button type="reset" class="btn btn-secondary ms-2" onclick="resetForm()">Reset Form</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
select[multiple] {
    height: 120px !important;
}

.form-select option {
    padding: 8px;
}

.form-select option:checked {
    background-color: #0d6efd;
    color: white;
}

.card {
    box-shadow: 0 0 15px rgba(0,0,0,0.1);
}

.form-label {
    font-weight: 500;
    margin-bottom: 0.5rem;
}

.form-text {
    margin-top: 0.25rem;
    font-size: 0.875em;
}

@media (max-width: 768px) {
    select[multiple] {
        height: 100px !important;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Event Create Script Loaded'); // Debug log

    // Function to toggle additional fields
    function toggleFields() {
        console.log('toggleFields called'); // Debug log
        const eventType = document.getElementById('event_type').value;
        const examFields = document.querySelectorAll('.exam-field');
        const isExamSchedule = eventType === 'Exam_schedule';

        console.log('Event Type:', eventType, 'Is Exam Schedule:', isExamSchedule); // Debug log

        examFields.forEach(field => {
            field.style.display = isExamSchedule ? 'block' : 'none';
            const inputs = field.querySelectorAll('select, input:not([type="checkbox"])');
            inputs.forEach(input => {
                if (isExamSchedule) {
                    input.setAttribute('required', 'required');
                } else {
                    input.removeAttribute('required');
                }
            });
        });
    }

    // Function to handle select all functionality
    function setupSelectAll(selectAllId, selectId) {
        const selectAllCheckbox = document.getElementById(selectAllId);
        const selectElement = document.getElementById(selectId);
        
        if (selectAllCheckbox && selectElement) {
            selectAllCheckbox.addEventListener('change', function() {
                const options = selectElement.options;
                for (let i = 0; i < options.length; i++) {
                    options[i].selected = selectAllCheckbox.checked;
                }
            });

            selectElement.addEventListener('change', function() {
                const options = selectElement.options;
                let allSelected = true;
                for (let i = 0; i < options.length; i++) {
                    if (!options[i].selected) {
                        allSelected = false;
                        break;
                    }
                }
                selectAllCheckbox.checked = allSelected;
            });
        }
    }

    // Setup select all for each multi-select
    setupSelectAll('selectAllDepts', 'departments');
    setupSelectAll('selectAllSems', 'semesters');
    setupSelectAll('selectAllCourses', 'courses');
    setupSelectAll('selectAllYears', 'years');

    // Reset form handler
    function resetForm() {
        console.log('resetForm called'); // Debug log
        const form = document.querySelector('form');
        form.reset();
        document.getElementById('visibility').value = 'Teachers';
        toggleFields(); // Hide exam fields on reset
        const checkboxes = document.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(checkbox => checkbox.checked = false);
    }

    // Add event listener for event_type change
    const eventTypeSelect = document.getElementById('event_type');
    if (eventTypeSelect) {
        eventTypeSelect.addEventListener('change', toggleFields);
        console.log('Event listener added to event_type'); // Debug log
    } else {
        console.error('event_type element not found'); // Debug log
    }

    // Initial call to set field visibility
    toggleFields();
});
</script>
{% endblock %}