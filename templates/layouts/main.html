<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OEP Portal</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/qa.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/notification.css') }}">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">

    <style>

    </style>
  </head>
  <body>
    <!-- Global Loader -->
    <div class="loader-overlay" id="globalLoader">
        <div class="loader"><div></div></div>
    </div>

    <div class="dashboard-container">
      <!-- Sidebar -->
      <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <div>
            <h4>OEP</h4>
            <small>
              {% if session['role'] == 'Admin' %}
                Admin Panel
              {% elif session['role'] == 'Teacher' %}
                Teacher Portal                        
              {% elif session['role'] == 'Student' %}
                Student Portal       
              {% endif %}
            </small>
          </div>
        </div>
        <nav class="sidebar-nav">
          {% if session['role'] == 'Admin' %}
            <a href="{{ url_for('dashboard') }}" 
            class="sidebar-nav-item {% if request.endpoint == 'dashboard' %}active{% endif %}">
              <i class="bi bi-speedometer2"></i> <span>Dashboard</span>
            </a>
            <a href="{{ url_for('teacher_management') }}" class="sidebar-nav-item">
              <i class="bi bi-people"></i> <span>Teacher Management</span>
            </a>
            <a href="{{ url_for('student_management')}}" class="sidebar-nav-item">
              <i class="bi bi-person-lines-fill"></i> <span>Student Management</span>
            </a>
            <a href="{{ url_for('course_management')}}" class="sidebar-nav-item">
              <i class="bi bi-person-lines-fill"></i> <span>Course Management</span>
            </a>
            <a href="{{ url_for('event_calendar')}}" class="sidebar-nav-item {% if request.endpoint == 'events' %}active{% endif %}">
              <i class="bi bi-calendar-event"></i> <span>Events</span>
            </a>
            <!-- <a href="#" class="sidebar-nav-item {% if request.endpoint == 'timetable' %}active{% endif %}">
              <i class="bi bi-table"></i> <span>Timetable</span>
            </a> -->
            <a href="{{ url_for('admin_setting') }}" class="sidebar-nav-item {% if request.endpoint == 'admin_setting' %}active{% endif %}">
              <i class="bi bi-gear"></i> <span>Settings</span>
            </a>
          {% elif session['role'] == 'Teacher' %}
            <a href="{{ url_for('dashboard') }}" 
                class="sidebar-nav-item {% if request.endpoint == 'dashboard' %}active{% endif %}">
              <i class="bi bi-speedometer2"></i> <span>Dashboard</span>
            </a>
            <a href="{{ url_for('teacher_events') }}" class="sidebar-nav-item {% if request.endpoint == 'teacher_events' %}active{% endif %}">
              <i class="bi bi-calendar-event"></i> <span>Events Management</span>
            </a>
            <!-- <a href="#" class="sidebar-nav-item {% if request.endpoint == 'conduct_test' %}active{% endif %}">
              <i class="bi bi-journal-check"></i> <span>Conduct New Test</span>
            </a>
            <a href="#" class="sidebar-nav-item {% if request.endpoint == 'send_alert' %}active{% endif %}">
              <i class="bi bi-bell"></i> <span>Send Alert</span>
            </a>
            <a href="#" class="sidebar-nav-item {% if request.endpoint == 'evaluate' %}active{% endif %}">
              <i class="bi bi-check-square"></i> <span>Evaluate / Correction</span>
            </a>
            <a href="#" class="sidebar-nav-item {% if request.endpoint == 'view_attendance' %}active{% endif %}">
              <i class="bi bi-calendar-check"></i> <span>View Student Attendance</span>
            </a>
            <a href="#" class="sidebar-nav-item {% if request.endpoint == 'view_class' %}active{% endif %}">
              <i class="bi bi-people"></i> <span>View Class</span>
            </a> -->
            <a href="{{ url_for('question_bank') }}" class="sidebar-nav-item {% if request.endpoint == 'question_banks' %}active{% endif %}">
              <i class="bi bi-archive"></i> <span>Question Banks/Questions</span>
            </a>
          {% elif session['role'] == 'Student' %}
<<<<<<< HEAD
            <a href="{{ url_for('student_events')}}" class="sidebar-nav-item {% if request.endpoint == 'student_events' %}active{% endif %}">
              <i class="bi bi-pencil-square"></i> <span>Check Exam / View Exam</span>
            </a>
            <a href="{{ url_for('student_all_results')}}" class="sidebar-nav-item {% if request.endpoint == 'student_results' %}active{% endif %}">
              <i class="bi bi-graph-up"></i> <span>View Scores / Marks</span>
            </a>
            <a href="#" class="sidebar-nav-item {% if request.endpoint == 'appeal' %}active{% endif %}">
              <i class="bi bi-chat-dots"></i> <span>Appeal</span>
            </a>
=======
>>>>>>> 6bd70aa5ace8f821e53980252cccfcfebeb2212d
            <a href="{{ url_for('dashboard') }}" 
                  class="sidebar-nav-item {% if request.endpoint == 'dashboard' %}active{% endif %}">
              <i class="bi bi-speedometer2"></i> <span>Dashboard</span>
            </a>
            <a href="{{ url_for('student_events')}}" class="sidebar-nav-item {% if request.endpoint == 'student_events' %}active{% endif %}">
              <i class="bi bi-pencil-square"></i> <span>Events / Exams</span>
            </a>
            <a href="#" class="sidebar-nav-item {% if request.endpoint == 'view_scores' %}active{% endif %}">
              <i class="bi bi-graph-up"></i> <span>View Scores / Marks</span>
            </a>
            <!-- <a href="#" class="sidebar-nav-item {% if request.endpoint == 'appeal' %}active{% endif %}">
              <i class="bi bi-chat-dots"></i> <span>Appeal</span>
            </a> -->
          {% endif %}
        </nav>
        <div class="sidebar-logout">
          <a href="{{ url_for('logout') }}" class="sidebar-nav-item">
            <i class="bi bi-box-arrow-right"></i> <span>Logout</span>
          </a>
        </div>
      </div>

      <!-- Top Navbar -->
      <nav class="top-navbar navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
          <button class="sidebar-toggle" id="sidebarToggle">
            <i class="bi bi-list"></i>
          </button>
          <div class="collapse navbar-collapse justify-content-end">
            <ul class="navbar-nav align-items-center">
              <!-- Notification Bell -->
              <li class="nav-item position-relative me-3">
                <a class="nav-link text-white position-relative" href="#" onclick="togglePopup(event)">
                  <i class="bi bi-bell fs-5"></i>
                  <span id="notificationBadge" class="position-absolute top-30 start-10 translate-middle badge rounded-pill bg-danger" style="display: none;">
                    0
                    <span class="visually-hidden">unread messages</span>
                  </span>
                </a>
                <div id="notificationPopup" class="notification-popup">
                  <ul id="notificationList" class="list-group list-group-flush">
                    <h5 class="notifi">Notifications</h5>
                  </ul>
                  <div id="emptyMessage" class="list-group-item text-center empty-message">
                    No messages received yet.
                  </div>
                </div>
              </li>
              <!-- Profile Section -->
              <li class="nav-item">
                <a class="navbar-brand" href="#">
                  <img src="{{ url_for('static', filename='images/profile.jpg') }}" alt="Profile" class="profile-img me-2">
                  <span class="text-white">{{ session['username'] }}</span>
                </a>
              </li>
            </ul>
          </div>
        </div>
      </nav>

      <!-- Main Content -->
      <main class="main-content" id="Content">
        {% block content %}{% endblock %}
      </main>

      <!-- Footer -->
      <footer class="footer bg-light py-3 border-top">
        <div class="container-fluid">
          <div class="row w-100 m-0">
            <div class="col-md-6">
              <p class="mb-0">Â© 2024 OEP. All rights reserved.</p>
            </div>
            <div class="col-md-6 text-md-end">
              <a href="#" class="text-muted me-3">Privacy Policy</a>
              <a href="#" class="text-muted">Terms of Service</a>
            </div>
          </div>
        </div>
      </footer>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.socket.io/4.0.1/socket.io.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script src="{{ url_for('static', filename='js/notification.js') }}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.js"></script>

    <script>
      // Loader Functions
      function showLoader() {
        document.getElementById('globalLoader').classList.add('show');
      }

      function hideLoader() {
        document.getElementById('globalLoader').classList.remove('show');
      }

      // Toastr Configuration
      toastr.options = {
        closeButton: true,
        progressBar: true,
        positionClass: 'toast-top-right',
        timeOut: 5000,
        extendedTimeOut: 1000,
        preventDuplicates: true,
      };

      // Socket.IO Setup
      const socket = io('http://localhost:5000/teachers', {
        transports: ['websocket']
      });

      socket.on('connect', () => {
        console.log('WebSocket connected');
      });

      socket.on('connect_error', (error) => {
        console.error('WebSocket connection error:', error);
      });

      socket.on('new_event_notification', (data) => {
        console.log('New notification:', data);
        displayNotification(data);
        toastr.success(`${data.title} - ${data.event_date}`, 'New Event');
      });

      // Notification Popup Functions
      function togglePopup(event) {
        event.preventDefault();
        const popup = document.getElementById('notificationPopup');
        const isVisible = popup.classList.contains('show');

        if (isVisible) {
          popup.classList.remove('show');
        } else {
          popup.classList.add('show');
          fetchNotifications();
        }
      }

      function closePopup(popup) {
        popup.classList.remove('show');
        document.removeEventListener('click', handleOutsideClick);
      }

      function fetchNotifications() {
        showLoader();
        fetch('/get_notifications')
          .then(response => response.json())
          .then(data => {
            const notificationList = document.getElementById('notificationList');
            const notificationBadge = document.getElementById('notificationBadge');
            const emptyMessage = document.getElementById('emptyMessage');

            notificationList.innerHTML = '<h5 class="notifi">Notifications</h5>';

            if (data.length > 0) {
              data.forEach(notification => {
                const listItem = document.createElement('li');
                listItem.classList.add('list-group-item');
                listItem.innerHTML = `
                  <div>
                    <h6 class="mb-1">${notification.title}</h6>
                    <p class="mb-1">Date: ${notification.event_date}</p>
                    <p class="mb-1">Type: ${notification.type}</p>
                  </div>
                  <button class="btn btn-danger btn-sm" onclick="deleteNotification(event, this, ${notification.id})">
                    <i class="bi bi-trash"></i>
                  </button>
                `;
                notificationList.appendChild(listItem);
              });
              updateNotificationBadge(data.length);
              emptyMessage.style.display = 'none';
            } else {
              emptyMessage.style.display = 'block';
            }
          })
          .catch(error => {
            console.error('Error fetching notifications:', error);
            toastr.error('Failed to fetch notifications');
          })
          .finally(() => hideLoader());
      }

      function handleOutsideClick(event) {
        const popup = document.getElementById('notificationPopup');
        const isClickInside = popup.contains(event.target);
        const bellIcon = event.target.closest('.nav-link');
        
        if (!isClickInside && !bellIcon) {
          closePopup(popup);
        }
      }

      function displayNotification(notificationData) {
        const notificationList = document.getElementById('notificationList');
        const emptyMessage = document.getElementById('emptyMessage');
        
        const listItem = document.createElement('li');
        listItem.classList.add('list-group-item');
        listItem.innerHTML = `
          <div>${notificationData.title} - ${notificationData.event_date}</div>
          <button class="btn btn-danger btn-sm" onclick="deleteNotification(event, this, ${notificationData.id})">
            <i class="bi bi-trash"></i>
          </button>
        `;
        
        notificationList.appendChild(listItem);
        updateNotificationBadge(notificationList.children.length);

        if (notificationList.children.length > 0) {
          emptyMessage.style.display = 'none';
          notificationList.style.display = 'block';
        }
      }

      function deleteNotification(event, button, notificationId) {
        event.stopPropagation();
        showLoader();
        fetch(`/delete_notification/${notificationId}`, { method: 'DELETE' })
          .then(response => {
            if (response.ok) {
              const listItem = button.closest('li');
              listItem.remove();
              updateNotificationBadge(document.querySelectorAll('#notificationList li').length);
              toastr.success('Notification deleted successfully');
            } else {
              toastr.error('Failed to delete notification');
            }
          })
          .catch(error => {
            console.error('Error deleting notification:', error);
            toastr.error('Error deleting notification');
          })
          .finally(() => hideLoader());
      }

      function updateNotificationBadge(count) {
        const notificationBadge = document.getElementById('notificationBadge');
        if (count > 0) {
          notificationBadge.textContent = count;
          notificationBadge.style.display = 'inline-block';
        } else {
          notificationBadge.style.display = 'none';
        }
      }

      // Intercept all fetch requests to show/hide loader
      (function() {
        const originalFetch = window.fetch;
        window.fetch = function() {
          showLoader();
          return originalFetch.apply(this, arguments)
            .finally(() => hideLoader());
        };
      })();

      // Fetch notifications on page load
      document.addEventListener('DOMContentLoaded', fetchNotifications);
    </script>
  </body>
</html>